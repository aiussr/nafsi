<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence-Based Authority Framework</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        
        #visualization {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            text-anchor: middle;
        }
        
        .subtitle {
            font-size: 14px;
            text-anchor: middle;
        }
        
        .authority-box {
            stroke-width: 2;
            rx: 10;
            ry: 10;
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.2));
        }
        
        .authority-title {
            font-size: 18px;
            font-weight: bold;
            fill: white;
            text-anchor: middle;
        }
        
        .authority-subtitle {
            font-size: 12px;
            fill: white;
            text-anchor: middle;
        }
        
        .authority-text {
            font-size: 11px;
            fill: white;
            text-anchor: middle;
        }
        
        .case-study-circle {
            filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.2));
            stroke-width: 2;
        }
        
        .case-study-title {
            font-size: 14px;
            font-weight: bold;
            text-anchor: middle;
        }
        
        .case-study-text {
            font-size: 11px;
            text-anchor: middle;
        }
        
        .info-box {
            fill: #f0f0f0;
            stroke: #999;
            stroke-width: 1;
            rx: 8;
            ry: 8;
        }
        
        .info-title {
            font-size: 16px;
            font-weight: bold;
            text-anchor: middle;
        }
        
        .info-text {
            font-size: 11px;
            text-anchor: start;
        }
        
        .info-center-text {
            font-size: 11px;
            text-anchor: middle;
        }
        
        .connection {
            fill: none;
            stroke-opacity: 0.7;
            stroke-width: 2;
        }
        
        .connection-label {
            font-size: 10px;
            text-anchor: middle;
        }
        
        .zone-label {
            font-size: 14px;
            font-weight: bold;
            text-anchor: middle;
        }
        
        .zone-text {
            font-size: 11px;
            text-anchor: middle;
        }
        
        .legitimacy-title {
            font-size: 18px;
            font-weight: bold;
            text-anchor: middle;
        }
        
        .legitimacy-text {
            font-size: 12px;
            text-anchor: middle;
        }
        
        .leader-line {
            stroke: #999;
            stroke-width: 1.5;
            stroke-dasharray: 3,2;
            fill: none;
        }
        
        /* Make connections highlight when hovering over related elements */
        .case-study:hover .case-study-circle {
            stroke-width: 3;
        }
        
        .case-study:hover + .connection {
            stroke-width: 3;
            stroke-opacity: 1;
        }
        
        /* Interactive tooltip */
        .tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <div id="visualization"></div>
    <div class="tooltip"></div>

    <script>
        // Define the main SVG dimensions
        const width = 1200;
        const height = 1100;
        
        // Create the SVG container
        const svg = d3.select("#visualization")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet");
            
        // Create a tooltip
        const tooltip = d3.select(".tooltip");
        
        // Define gradient definitions
        const defs = svg.append("defs");
        
        // Authority type gradients
        createLinearGradient(defs, "formal-gradient", "#4568DC", "#3A6073");
        createLinearGradient(defs, "expert-gradient", "#56ab2f", "#a8e063");
        createLinearGradient(defs, "moral-gradient", "#b24592", "#f15f79");
        createLinearGradient(defs, "social-gradient", "#FF8008", "#FFC837");
        createLinearGradient(defs, "digital-gradient", "#03A9F4", "#81D4FA");
        
        // Case study gradients
        createLinearGradient(defs, "trump-gradient", "#e74c3c", "#e74c3c", 0.2, 0.5);
        createLinearGradient(defs, "cohn-gradient", "#9b59b6", "#9b59b6", 0.2, 0.5);
        createLinearGradient(defs, "muhammad-gradient", "#3498db", "#3498db", 0.2, 0.5);
        createLinearGradient(defs, "thatcher-gradient", "#2ecc71", "#2ecc71", 0.2, 0.5);
        createLinearGradient(defs, "merkel-gradient", "#f39c12", "#f39c12", 0.2, 0.5);
        createLinearGradient(defs, "chamath-gradient", "#1abc9c", "#1abc9c", 0.2, 0.5);
        
        // Create arrow markers for different connection types
        createArrowMarker(defs, "formal-arrow", "#4568DC");
        createArrowMarker(defs, "expert-arrow", "#56ab2f");
        createArrowMarker(defs, "moral-arrow", "#b24592");
        createArrowMarker(defs, "social-arrow", "#FF8008");
        createArrowMarker(defs, "digital-arrow", "#03A9F4");
        
        // Case study arrow markers
        createArrowMarker(defs, "trump-arrow", "#e74c3c");
        createArrowMarker(defs, "cohn-arrow", "#9b59b6");
        createArrowMarker(defs, "muhammad-arrow", "#3498db");
        createArrowMarker(defs, "thatcher-arrow", "#2ecc71");
        createArrowMarker(defs, "merkel-arrow", "#f39c12");
        createArrowMarker(defs, "chamath-arrow", "#1abc9c");
        
        // Pattern for the Zone of Acceptance
        const pattern = defs.append("pattern")
            .attr("id", "acceptance-zone")
            .attr("patternUnits", "userSpaceOnUse")
            .attr("width", 10)
            .attr("height", 10);
            
        pattern.append("rect")
            .attr("width", 10)
            .attr("height", 10)
            .attr("fill", "#f5f5f5");
            
        pattern.append("path")
            .attr("d", "M-1,1 l2,-2 M0,10 l10,-10 M9,11 l2,-2")
            .attr("stroke", "#dddddd")
            .attr("stroke-width", 1);
            
        // Add title and subtitle
        svg.append("text")
            .attr("class", "title")
            .attr("x", width / 2)
            .attr("y", 35)
            .text("Evidence-Based Authority Framework");
            
        svg.append("text")
            .attr("class", "subtitle")
            .attr("x", width / 2)
            .attr("y", 60)
            .attr("fill", "#666")
            .text("Based on empirical research across organizational contexts and case studies");
            
        // Add the Zone of Acceptance
        const centerX = 600;
        const centerY = 400;
        
        svg.append("circle")
            .attr("cx", centerX)
            .attr("cy", centerY)
            .attr("r", 130)
            .attr("fill", "url(#acceptance-zone)")
            .attr("stroke", "#999")
            .attr("stroke-width", 2)
            .attr("stroke-dasharray", "5,3");
            
        // Zone of Acceptance label box
        const zoneLabel = svg.append("g")
            .attr("transform", "translate(730, 290)");
            
        zoneLabel.append("rect")
            .attr("width", 160)
            .attr("height", 60)
            .attr("rx", 5)
            .attr("ry", 5)
            .attr("fill", "white")
            .attr("stroke", "#999")
            .attr("stroke-width", 1);
            
        zoneLabel.append("text")
            .attr("class", "zone-label")
            .attr("x", 80)
            .attr("y", 20)
            .attr("fill", "#555")
            .text("\"Zone of Acceptance\"");
            
        zoneLabel.append("text")
            .attr("class", "zone-text")
            .attr("x", 80)
            .attr("y", 40)
            .attr("fill", "#666")
            .text("70% of directives accepted");
            
        zoneLabel.append("text")
            .attr("class", "zone-text")
            .attr("x", 80)
            .attr("y", 55)
            .attr("fill", "#666")
            .text("without question (Barnard)");
            
        // Leader line
        svg.append("path")
            .attr("d", "M 730 320 L 700 350")
            .attr("class", "leader-line");
            
        // Legitimacy Core
        svg.append("circle")
            .attr("cx", centerX)
            .attr("cy", centerY)
            .attr("r", 80)
            .attr("fill", "#f8f8f8")
            .attr("stroke", "#666")
            .attr("stroke-width", 2);
            
        svg.append("text")
            .attr("class", "legitimacy-title")
            .attr("x", centerX)
            .attr("y", centerY - 15)
            .text("Legitimacy Core");
            
        svg.append("text")
            .attr("class", "legitimacy-text")
            .attr("x", centerX)
            .attr("y", centerY + 5)
            .attr("fill", "#666")
            .text("(Tyler: voluntary compliance");
            
        svg.append("text")
            .attr("class", "legitimacy-text")
            .attr("x", centerX)
            .attr("y", centerY + 20)
            .attr("fill", "#666")
            .text("without coercive force)");

        // Define data for authority types
        const authorityTypes = [
            {
                id: "formal",
                title: "Formal Authority",
                subtitle: "Position-Based Power",
                details: [
                    "84% compliance when legitimate",
                    "42% compliance when questioned",
                    "(Tyler & Huo, 2002)"
                ],
                x: 350,
                y: 200,
                width: 170,
                height: 120,
                gradient: "url(#formal-gradient)",
                markerEnd: "url(#formal-arrow)",
                pathToCore: "M 435 320 C 480 360, 500 380, 520 400"
            },
            {
                id: "expert",
                title: "Expert Authority",
                subtitle: "Knowledge-Based Influence",
                details: [
                    "3.2x greater influence than",
                    "non-experts in same position",
                    "(Cross & Prusak, 2002)"
                ],
                x: 680,
                y: 200,
                width: 170,
                height: 120,
                gradient: "url(#expert-gradient)",
                markerEnd: "url(#expert-arrow)",
                pathToCore: "M 765 320 C 720 360, 700 380, 680 400"
            },
            {
                id: "moral",
                title: "Moral Authority",
                subtitle: "Values-Based Leadership",
                details: [
                    "+35% voluntary effort from",
                    "followers; -22% monitoring needed",
                    "(Brown et al., 2005)"
                ],
                x: 350,
                y: 480,
                width: 170,
                height: 120,
                gradient: "url(#moral-gradient)",
                markerEnd: "url(#moral-arrow)",
                pathToCore: "M 435 480 C 480 440, 500 420, 520 400"
            },
            {
                id: "social",
                title: "Social Authority",
                subtitle: "Network-Based Influence",
                details: [
                    "Centrality predicts influence",
                    "r=0.74 across 38 organizations",
                    "(Brass & Burkhardt, 1993)"
                ],
                x: 680,
                y: 480,
                width: 170,
                height: 120,
                gradient: "url(#social-gradient)",
                markerEnd: "url(#social-arrow)",
                pathToCore: "M 765 480 C 720 440, 700 420, 680 400"
            },
            {
                id: "digital",
                title: "Digital Authority",
                subtitle: "Virtual Environment Influence",
                details: [
                    "Shifts 31% more frequently",
                    "Response time replaces presence",
                    "(Gibson & Cohen, 2003)"
                ],
                x: 900,
                y: 340,
                width: 170,
                height: 120,
                gradient: "url(#digital-gradient)",
                markerEnd: "url(#digital-arrow)",
                pathToCore: "M 900 400 C 850 400, 800 400, 730 400"
            }
        ];
        
        // Define data for case studies
        const caseStudies = [
            {
                id: "trump",
                name: "Donald Trump",
                details: [
                    "Attention Capture",
                    "$5.9B media value",
                    "4-5x engagement"
                ],
                x: 130,
                y: 800,
                radius: 55,
                fill: "url(#trump-gradient)",
                stroke: "#e74c3c",
                connections: [
                    {
                        target: "social",
                        path: "M 190 790 C 300 700, 400 650, 435 600",
                        markerEnd: "url(#trump-arrow)",
                        label: "To Social Authority",
                        labelX: 330,
                        labelY: 680
                    },
                    {
                        target: "moral",
                        path: "M 190 770 C 350 700, 500 630, 680 530",
                        markerEnd: "url(#trump-arrow)",
                        label: "To Moral Authority",
                        labelX: 450,
                        labelY: 630
                    }
                ]
            },
            {
                id: "cohn",
                name: "Roy Cohn",
                details: [
                    "Information Gatekeeper",
                    "17 daily calls to power",
                    "68% case settlement"
                ],
                x: 320,
                y: 800,
                radius: 55,
                fill: "url(#cohn-gradient)",
                stroke: "#9b59b6",
                connections: [
                    {
                        target: "formal",
                        path: "M 350 750 C 370 700, 390 650, 410 550",
                        markerEnd: "url(#cohn-arrow)",
                        label: "To Formal Authority",
                        labelX: 380,
                        labelY: 650
                    },
                    {
                        target: "social",
                        path: "M 380 765 C 420 700, 460 640, 500 320",
                        markerEnd: "url(#cohn-arrow)",
                        label: "To Social Authority",
                        labelX: 450,
                        labelY: 520
                    }
                ]
            },
            {
                id: "muhammad",
                name: "Muhammad",
                details: [
                    "Authority Evolution",
                    "Charismatic to",
                    "Institutional"
                ],
                x: 510,
                y: 800,
                radius: 55,
                fill: "url(#muhammad-gradient)",
                stroke: "#3498db",
                connections: [
                    {
                        target: "moral",
                        path: "M 520 750 C 500 700, 460 650, 430 600",
                        markerEnd: "url(#muhammad-arrow)",
                        label: "To Moral Authority",
                        labelX: 480,
                        labelY: 670
                    },
                    {
                        target: "formal",
                        path: "M 560 750 C 600 700, 620 650, 625 550",
                        markerEnd: "url(#muhammad-arrow)",
                        label: "To Formal Authority",
                        labelX: 610,
                        labelY: 650
                    },
                    {
                        target: "social",
                        path: "M 570 765 C 620 710, 650 650, 700 550",
                        markerEnd: "url(#muhammad-arrow)",
                        label: "To Social Authority",
                        labelX: 670,
                        labelY: 630
                    }
                ]
            },
            {
                id: "thatcher",
                name: "Thatcher",
                details: [
                    "Conviction Authority",
                    "91% voting consistency",
                    "3.2x use of absolutes"
                ],
                x: 700,
                y: 800,
                radius: 55,
                fill: "url(#thatcher-gradient)",
                stroke: "#2ecc71",
                connections: [
                    {
                        target: "moral",
                        path: "M 700 750 C 670 700, 620 650, 500 540",
                        markerEnd: "url(#thatcher-arrow)",
                        label: "To Moral Authority",
                        labelX: 600,
                        labelY: 620
                    },
                    {
                        target: "formal",
                        path: "M 670 750 C 600 680, 550 620, 520 320",
                        markerEnd: "url(#thatcher-arrow)",
                        label: "To Formal Authority",
                        labelX: 540,
                        labelY: 500
                    }
                ]
            },
            {
                id: "merkel",
                name: "Merkel",
                details: [
                    "Crisis-Tested Authority",
                    "+18% approval in crisis",
                    "+34% EU voting support"
                ],
                x: 890,
                y: 800,
                radius: 55,
                fill: "url(#merkel-gradient)",
                stroke: "#f39c12",
                connections: [
                    {
                        target: "expert",
                        path: "M 880 750 C 850 680, 820 610, 780 320",
                        markerEnd: "url(#merkel-arrow)",
                        label: "To Expert Authority",
                        labelX: 830,
                        labelY: 570
                    },
                    {
                        target: "social",
                        path: "M 930 750 C 900 680, 860 610, 800 550",
                        markerEnd: "url(#merkel-arrow)",
                        label: "To Social Authority",
                        labelX: 870,
                        labelY: 620
                    }
                ]
            },
            {
                id: "chamath",
                name: "Chamath",
                details: [
                    "Credential Stacking",
                    "4.7% stock price impact",
                    "8-12x resharing rates"
                ],
                x: 1080,
                y: 800,
                radius: 55,
                fill: "url(#chamath-gradient)",
                stroke: "#1abc9c",
                connections: [
                    {
                        target: "expert",
                        path: "M 1065 750 C 1020 680, 950 610, 850 320",
                        markerEnd: "url(#chamath-arrow)",
                        label: "To Expert Authority",
                        labelX: 930,
                        labelY: 550
                    },
                    {
                        target: "digital",
                        path: "M 1110 750 C 1080 650, 1040 550, 985 460",
                        markerEnd: "url(#chamath-arrow)",
                        label: "To Digital Authority",
                        labelX: 1030,
                        labelY: 600
                    }
                ]
            }
        ];
        
        // Define data for info boxes
        const infoBoxes = [
            {
                title: "Authority Transformation",
                subtitle: "(Gardner & Avolio, 124 leaders)",
                items: [
                    "• Early career: Expert (skills)",
                    "• Mid career: Formal (position)",
                    "• Late career: Social/Moral (legacy)"
                ],
                x: 80,
                y: 160,
                width: 200,
                height: 180
            },
            {
                title: "Authority During Change",
                subtitle: "(Kotter, 38 companies)",
                items: [
                    "• Formal: -40% effectiveness",
                    "• Expert: +28% during planning",
                    "• Social: 2.3x more influential",
                    "• Balanced mix: 3.1x success",
                    "• Consistency key for all types"
                ],
                x: 80,
                y: 360,
                width: 200,
                height: 180
            },
            {
                title: "Cultural Variations",
                subtitle: "(GLOBE Study, 62 societies)",
                items: [
                    "• High Power Distance: Formal",
                    "authority dominates (+46%)",
                    "",
                    "• Low Power Distance: Expert",
                    "authority prioritized (+38%)",
                    "",
                    "• Collectivist: Social authority",
                    "most effective (1.7x impact)"
                ],
                x: 80,
                y: 560,
                width: 200,
                height: 180
            },
            {
                title: "Observable Indicators",
                items: [
                    "• Voluntary compliance (30-95%)",
                    "• Consultation patterns (Burt)",
                    "• Conversational deference",
                    "• Resource allocation influence",
                    "• Speaking time allocation (r=0.68)",
                    "• Physical/digital positioning"
                ],
                x: 900,
                y: 160,
                width: 200,
                height: 160
            }
        ];
        
        // Add digital authority label for clarity
        svg.append("text")
            .attr("x", 820)
            .attr("y", 385)
            .attr("class", "connection-label")
            .attr("fill", "#03A9F4")
            .text("To Legitimacy Core");
            
        // Add authority interaction matrix
        const matrix = svg.append("g")
            .attr("transform", "translate(900, 470)");
            
        matrix.append("rect")
            .attr("width", 220)
            .attr("height", 240)
            .attr("class", "info-box");
            
        matrix.append("text")
            .attr("class", "info-title")
            .attr("x", 110)
            .attr("y", 25)
            .text("Authority Interaction Matrix");
            
        matrix.append("line")
            .attr("x1", 30)
            .attr("y1", 35)
            .attr("x2", 190)
            .attr("y2", 35)
            .attr("stroke", "#999")
            .attr("stroke-width", 1);
            
        // Matrix headers and cells
        const authorityLetters = ["F", "E", "M", "S"];
        const authorityColors = ["#4568DC", "#56ab2f", "#b24592", "#FF8008"];
        
        // Column headers
        for (let i = 0; i < 4; i++) {
            matrix.append("rect")
                .attr("x", 60 + i * 30)
                .attr("y", 45)
                .attr("width", 30)
                .attr("height", 30)
                .attr("fill", authorityColors[i])
                .attr("fill-opacity", 0.7);
                
            matrix.append("text")
                .attr("x", 75 + i * 30)
                .attr("y", 65)
                .attr("font-size", 12)
                .attr("fill", "white")
                .attr("text-anchor", "middle")
                .text(authorityLetters[i]);
        }
        
        // Row headers
        for (let i = 0; i < 4; i++) {
            matrix.append("rect")
                .attr("x", 30)
                .attr("y", 75 + i * 30)
                .attr("width", 30)
                .attr("height", 30)
                .attr("fill", authorityColors[i])
                .attr("fill-opacity", 0.7);
                
            matrix.append("text")
                .attr("x", 45)
                .attr("y", 95 + i * 30)
                .attr("font-size", 12)
                .attr("fill", "white")
                .attr("text-anchor", "middle")
                .text(authorityLetters[i]);
        }
        
        // Matrix values
        const matrixValues = [
            ["--", "+", "++", "-"],
            ["++", "--", "+", "++"],
            ["-", "+", "--", "++"],
            ["-", "++", "++", "--"]
        ];
        
        for (let row = 0; row < 4; row++) {
            for (let col = 0; col < 4; col++) {
                matrix.append("rect")
                    .attr("x", 60 + col * 30)
                    .attr("y", 75 + row * 30)
                    .attr("width", 30)
                    .attr("height", 30)
                    .attr("fill", "#f0f0f0")
                    .attr("stroke", "#ddd")
                    .attr("stroke-width", 1);
                    
                matrix.append("text")
                    .attr("x", 75 + col * 30)
                    .attr("y", 95 + row * 30)
                    .attr("font-size", 11)
                    .attr("fill", "#333")
                    .attr("text-anchor", "middle")
                    .text(matrixValues[row][col]);
            }
        }
        
        // Matrix legend
        matrix.append("text")
            .attr("class", "info-center-text")
            .attr("x", 110)
            .attr("y", 210)
            .attr("fill", "#666")
            .text("++ Strongly reinforcing");
            
        matrix.append("text")
            .attr("class", "info-center-text")
            .attr("x", 110)
            .attr("y", 225)
            .attr("fill", "#666")
            .text("+ Complementary, - Tension");
            
        matrix.append("text")
            .attr("class", "info-center-text")
            .attr("x", 110)
            .attr("y", 240)
            .attr("fill", "#666")
            .text("-- Same type competition");
        
        // Authority transformation timeline for the first info box
        const timeline = svg.select("g")
            .data([infoBoxes[0]])
            .enter()
            .append("g")
            .attr("transform", `translate(${infoBoxes[0].x}, ${infoBoxes[0].y + 70})`);
            
        timeline.append("line")
            .attr("x1", 40)
            .attr("y1", 10)
            .attr("x2", 160)
            .attr("y2", 10)
            .attr("stroke", "#666")
            .attr("stroke-width", 2);
            
        const phases = ["Expert", "Formal", "Social", "Moral"];
        const phaseColors = ["#56ab2f", "#4568DC", "#FF8008", "#b24592"];
        
        for (let i = 0; i < 4; i++) {
            timeline.append("circle")
                .attr("cx", 40 + i * 40)
                .attr("cy", 10)
                .attr("r", 5)
                .attr("fill", phaseColors[i]);
                
            timeline.append("text")
                .attr("x", 40 + i * 40)
                .attr("cy", 25)
                .attr("font-size", 11)
                .attr("fill", "#333")
                .attr("text-anchor", "middle")
                .text(phases[i]);
        }
            
        // Create authority type boxes
        const authorityGroups = svg.selectAll(".authority")
            .data(authorityTypes)
            .enter()
            .append("g")
            .attr("class", d => `authority authority-${d.id}`)
            .attr("transform", d => `translate(${d.x}, ${d.y})`)
            .on("mouseover", function(event, d) {
                // Highlight related case studies
                d3.selectAll(`.connection-${d.id}`)
                    .attr("stroke-width", 3)
                    .attr("stroke-opacity", 1);
                    
                // Show tooltip
                tooltip.style("opacity", 1)
                    .html(`<strong>${d.title}</strong><br>
                           ${d.details.join("<br>")}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");
            })
            .on("mouseout", function(event, d) {
                // Reset highlights
                d3.selectAll(`.connection-${d.id}`)
                    .attr("stroke-width", 2)
                    .attr("stroke-opacity", 0.7);
                    
                // Hide tooltip
                tooltip.style("opacity", 0);
            });
            
        authorityGroups.append("rect")
            .attr("class", "authority-box")
            .attr("width", d => d.width)
            .attr("height", d => d.height)
            .attr("fill", d => d.gradient);
            
        authorityGroups.append("text")
            .attr("class", "authority-title")
            .attr("x", d => d.width / 2)
            .attr("y", 25)
            .text(d => d.title);
            
        authorityGroups.append("text")
            .attr("class", "authority-subtitle")
            .attr("x", d => d.width / 2)
            .attr("y", 45)
            .text(d => d.subtitle);
            
        authorityGroups.append("line")
            .attr("x1", 40)
            .attr("y1", 55)
            .attr("x2", 130)
            .attr("y2", 55)
            .attr("stroke", "white")
            .attr("stroke-width", 1);
            
        // Add details for each authority type
        authorityGroups.each(function(d) {
            const group = d3.select(this);
            d.details.forEach((detail, i) => {
                group.append("text")
                    .attr("class", "authority-text")
                    .attr("x", d.width / 2)
                    .attr("y", 75 + i * 20)
                    .text(detail);
            });
        });
        
        // Add paths from authority types to legitimacy core
        authorityTypes.forEach(d => {
            svg.append("path")
                .attr("d", d.pathToCore)
                .attr("class", "connection")
                .attr("stroke", d.stroke || getColorFromGradient(d.gradient))
                .attr("marker-end", d.markerEnd);
        });
        
        // Create info boxes
        const infoGroups = svg.selectAll(".info-box-group")
            .data(infoBoxes)
            .enter()
            .append("g")
            .attr("class", "info-box-group")
            .attr("transform", d => `translate(${d.x}, ${d.y})`);
            
        infoGroups.append("rect")
            .attr("class", "info-box")
            .attr("width", d => d.width)
            .attr("height", d => d.height);
            
        infoGroups.append("text")
            .attr("class", "info-title")
            .attr("x", d => d.width / 2)
            .attr("y", 25)
            .text(d => d.title);
            
        infoGroups.each(function(d) {
            const group = d3.select(this);
            
            if (d.subtitle) {
                group.append("text")
                    .attr("x", d.width / 2)
                    .attr("y", 45)
                    .attr("font-size", 12)
                    .attr("fill", "#666")
                    .attr("text-anchor", "middle")
                    .text(d.subtitle);
                    
                group.append("line")
                    .attr("x1", 30)
                    .attr("y1", 55)
                    .attr("x2", d.width - 30)
                    .attr("y2", 55)
                    .attr("stroke", "#999")
                    .attr("stroke-width", 1);
            }
            
            // Add items
            d.items.forEach((item, i) => {
                group.append("text")
                    .attr("class", "info-text")
                    .attr("x", 20)
                    .attr("y", (d.subtitle ? 80 : 60) + i * 20)
                    .text(item);
            });
        });
        
        // Create case study nodes with properly connected arrows
        const caseStudyGroups = svg.selectAll(".case-study")
            .data(caseStudies)
            .enter()
            .append("g")
            .attr("class", d => `case-study case-study-${d.id}`)
            .attr("transform", d => `translate(${d.x}, ${d.y})`)
            .on("mouseover", function(event, d) {
                // Highlight this case study
                d3.select(this).select("circle")
                    .attr("stroke-width", 3);
                    
                // Highlight connections from this case study
                d3.selectAll(`.connection-from-${d.id}`)
                    .attr("stroke-width", 3)
                    .attr("stroke-opacity", 1);
                    
                // Show tooltip
                tooltip.style("opacity", 1)
                    .html(`<strong>${d.name}</strong><br>
                           ${d.details.join("<br>")}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 20) + "px");
            })
            .on("mouseout", function(event, d) {
                // Reset highlights
                d3.select(this).select("circle")
                    .attr("stroke-width", 2);
                    
                d3.selectAll(`.connection-from-${d.id}`)
                    .attr("stroke-width", 2)
                    .attr("stroke-opacity", 0.7);
                    
                // Hide tooltip
                tooltip.style("opacity", 0);
            });
            
        caseStudyGroups.append("circle")
            .attr("class", "case-study-circle")
            .attr("cx", d => d.radius)
            .attr("cy", d => d.radius)
            .attr("r", d => d.radius)
            .attr("fill", d => d.fill)
            .attr("stroke", d => d.stroke);
            
        caseStudyGroups.append("text")
            .attr("class", "case-study-title")
            .attr("x", d => d.radius)
            .attr("y", d => d.radius - 20)
            .text(d => d.name);
            
        // Add details for each case study
        caseStudyGroups.each(function(d) {
            const group = d3.select(this);
            d.details.forEach((detail, i) => {
                group.append("text")
                    .attr("class", "case-study-text")
                    .attr("x", d.radius)
                    .attr("y", d.radius + i * 15)
                    .text(detail);
            });
        });
        
        // Add connections from case studies to authority types
        caseStudies.forEach(study => {
            study.connections.forEach(conn => {
                // Add the connection path
                svg.append("path")
                    .attr("d", conn.path)
                    .attr("class", `connection connection-from-${study.id} connection-${conn.target}`)
                    .attr("stroke", study.stroke)
                    .attr("marker-end", conn.markerEnd);
                    
                // Add the connection label
                svg.append("text")
                    .attr("class", "connection-label")
                    .attr("x", conn.labelX)
                    .attr("y", conn.labelY)
                    .attr("fill", study.stroke)
                    .text(conn.label);
            });
        });
        
        // Add legend
        const legend = svg.append("g")
            .attr("transform", "translate(310, 80)");
            
        legend.append("rect")
            .attr("width", 580)
            .attr("height", 60)
            .attr("rx", 5)
            .attr("ry", 5)
            .attr("fill", "white")
            .attr("stroke", "#aaa")
            .attr("stroke-width", 1);
            
        legend.append("text")
            .attr("x", 290)
            .attr("y", 20)
            .attr("font-size", 14)
            .attr("font-weight", "bold")
            .attr("fill", "#444")
            .attr("text-anchor", "middle")
            .text("Legend");
            
        // Authority flow legend
        legend.append("line")
            .attr("x1", 30)
            .attr("y1", 40)
            .attr("x2", 80)
            .attr("y2", 40)
            .attr("stroke", "#4568DC")
            .attr("stroke-width", 3)
            .attr("stroke-opacity", 0.7);
            
        legend.append("text")
            .attr("x", 125)
            .attr("y", 44)
            .attr("font-size", 11)
            .attr("fill", "#444")
            .attr("text-anchor", "middle")
            .text("Authority Flow");
            
        // Case study legend items
        const caseColors = [
            { id: "trump", color: "#e74c3c", name: "Trump" },
            { id: "cohn", color: "#9b59b6", name: "Cohn" },
            { id: "muhammad", color: "#3498db", name: "Muhammad" },
            { id: "thatcher", color: "#2ecc71", name: "Thatcher" },
            { id: "merkel", color: "#f39c12", name: "Merkel" },
            { id: "chamath", color: "#1abc9c", name: "Chamath" }
        ];
        
        caseColors.forEach((c, i) => {
            legend.append("circle")
                .attr("cx", 180 + i * 70)
                .attr("cy", 40)
                .attr("r", 8)
                .attr("fill", c.color)
                .attr("fill-opacity", 0.2)
                .attr("stroke", c.color)
                .attr("stroke-width", 1);
                
            legend.append("text")
                .attr("x", 215 + i * 70)
                .attr("y", 44)
                .attr("font-size", 11)
                .attr("fill", "#444")
                .attr("text-anchor", "middle")
                .text(c.name);
        });
        
        // Add footer text
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", height - 50)
            .attr("font-size", 12)
            .attr("fill", "#666")
            .attr("text-anchor", "middle")
            .text("Based on empirical research by Tyler, Cross & Prusak, Brown, Brass & Burkhardt, Gardner & Avolio, Gibson & Cohen, Kotter, GLOBE Study");
        
        // Helper function to create linear gradients
        function createLinearGradient(defs, id, color1, color2, opacity1 = 1, opacity2 = 1) {
            const gradient = defs.append("linearGradient")
                .attr("id", id)
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "100%");
                
            gradient.append("stop")
                .attr("offset", "0%")
                .attr("style", `stop-color:${color1};stop-opacity:${opacity1}`);
                
            gradient.append("stop")
                .attr("offset", "100%")
                .attr("style", `stop-color:${color2};stop-opacity:${opacity2}`);
                
            return gradient;
        }
        
        // Helper function to create arrow markers
        function createArrowMarker(defs, id, color) {
            const marker = defs.append("marker")
                .attr("id", id.replace(/^url\(#|\)$/g, ''))
                .attr("markerWidth", 10)
                .attr("markerHeight", 7)
                .attr("refX", 9)
                .attr("refY", 3.5)
                .attr("orient", "auto");
                
            marker.append("polygon")
                .attr("points", "0 0, 10 3.5, 0 7")
                .attr("fill", color);
                
            return marker;
        }
        
        // Helper function to extract color from gradient URL
        function getColorFromGradient(gradientUrl) {
            const id = gradientUrl.replace(/^url\(#|\)$/g, '');
            if (id === "formal-gradient") return "#4568DC";
            if (id === "expert-gradient") return "#56ab2f";
            if (id === "moral-gradient") return "#b24592";
            if (id === "social-gradient") return "#FF8008";
            if (id === "digital-gradient") return "#03A9F4";
            return "#333";
        }
    </script>
</body>
</html>
